# å¦‚ä½•æ·»åŠ è‡ªå®šä¹‰å­—æ®µ - å®è·µæŒ‡å—

## ğŸ¯ ç›®æ ‡

é€šè¿‡åŠ¨æ‰‹å®è·µï¼Œå­¦ä¼šå¦‚ä½•åœ¨ AgentState ä¸­æ·»åŠ è‡ªå®šä¹‰å­—æ®µï¼ˆå¦‚ user_id, languageï¼‰ï¼Œå¹¶è§‚å¯Ÿ State çš„å˜åŒ–ã€‚

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### ç¬¬ 1 æ­¥ï¼šè¿è¡Œç»ƒä¹ æ–‡ä»¶

```bash
# 1. æ¿€æ´»ç¯å¢ƒ
conda activate pytorch2.6.0

# 2. è¿è¡Œç»ƒä¹ 
python examples/practice_custom_state.py
```

### ç¬¬ 2 æ­¥ï¼šè§‚å¯Ÿè¾“å‡º

ä½ ä¼šçœ‹åˆ° 4 ä¸ªç»ƒä¹ çš„è¾“å‡ºï¼š

```
ç»ƒä¹  1: æ·»åŠ ç®€å•çš„è‡ªå®šä¹‰å­—æ®µ (user_id, language)
ç»ƒä¹  2: æ·»åŠ å¤æ‚çš„è‡ªå®šä¹‰å­—æ®µ (åå¥½ã€å…ƒæ•°æ®ã€ç»Ÿè®¡)
ç»ƒä¹  3: è§‚å¯Ÿ State åœ¨å¤šä¸ªèŠ‚ç‚¹é—´çš„å˜åŒ–
ç»ƒä¹  4: è½®åˆ°ä½ äº†ï¼ï¼ˆéœ€è¦ä½ è‡ªå·±å®ç°ï¼‰
```

---

## ğŸ“š è¯¦ç»†æ­¥éª¤æŒ‡å—

### ç»ƒä¹  1ï¼šæ·»åŠ ç®€å•å­—æ®µ

**å­¦ä¹ ç›®æ ‡**ï¼šç†è§£å¦‚ä½•å®šä¹‰å’Œä½¿ç”¨ç®€å•çš„è‡ªå®šä¹‰å­—æ®µ

#### æ­¥éª¤ 1ï¼šå®šä¹‰ State

```python
from typing import TypedDict, Optional

class MyCustomState(TypedDict):
    """è‡ªå®šä¹‰çš„ Agent çŠ¶æ€"""
    # åŸºç¡€å­—æ®µ
    question: str
    answer: Optional[str]
    
    # ğŸ¯ æ·»åŠ è‡ªå®šä¹‰å­—æ®µ
    user_id: str       # ç”¨æˆ·ID
    language: str      # è¯­è¨€è®¾ç½®
```

**å…³é”®ç‚¹**ï¼š
- âœ… ä½¿ç”¨ `TypedDict` å®šä¹‰ State
- âœ… æ¯ä¸ªå­—æ®µéƒ½æœ‰ç±»å‹æ³¨è§£
- âœ… ä½¿ç”¨ `Optional` è¡¨ç¤ºå¯é€‰å­—æ®µ

#### æ­¥éª¤ 2ï¼šåˆ›å»º State å®ä¾‹

```python
state = MyCustomState(
    question="Python æ˜¯ä»€ä¹ˆï¼Ÿ",
    answer=None,
    user_id="user-12345",    # ğŸ¯ è®¾ç½®è‡ªå®šä¹‰å­—æ®µ
    language="zh-CN"          # ğŸ¯ è®¾ç½®è‡ªå®šä¹‰å­—æ®µ
)

# ğŸ” è§‚å¯Ÿå­—æ®µå€¼
print(f"User ID: {state['user_id']}")      # user-12345
print(f"Language: {state['language']}")    # zh-CN
```

#### æ­¥éª¤ 3ï¼šåœ¨èŠ‚ç‚¹ä¸­ä½¿ç”¨è‡ªå®šä¹‰å­—æ®µ

```python
def my_custom_node(state: MyCustomState) -> MyCustomState:
    """ä½¿ç”¨è‡ªå®šä¹‰å­—æ®µçš„èŠ‚ç‚¹"""
    
    # ğŸ” è¯»å–è‡ªå®šä¹‰å­—æ®µ
    user_id = state['user_id']
    language = state['language']
    
    print(f"æ­£åœ¨ä¸ºç”¨æˆ· {user_id} å¤„ç†é—®é¢˜...")
    print(f"ä½¿ç”¨è¯­è¨€: {language}")
    
    # ğŸ¯ æ ¹æ®è‡ªå®šä¹‰å­—æ®µå®ç°ä¸åŒé€»è¾‘
    if language == 'zh-CN':
        state['answer'] = "Python æ˜¯ä¸€ç§é«˜çº§ç¼–ç¨‹è¯­è¨€ã€‚"
    else:
        state['answer'] = "Python is a high-level programming language."
    
    return state
```

#### ğŸ” è§‚å¯Ÿå˜åŒ–

è¿è¡Œå‰ï¼š
```python
{
    'question': 'Python æ˜¯ä»€ä¹ˆï¼Ÿ',
    'answer': None,
    'user_id': 'user-12345',
    'language': 'zh-CN'
}
```

è¿è¡Œåï¼š
```python
{
    'question': 'Python æ˜¯ä»€ä¹ˆï¼Ÿ',
    'answer': 'Python æ˜¯ä¸€ç§é«˜çº§ç¼–ç¨‹è¯­è¨€ã€‚',  # âœ… å·²æ›´æ–°
    'user_id': 'user-12345',
    'language': 'zh-CN'
}
```

---

### ç»ƒä¹  2ï¼šæ·»åŠ å¤æ‚å­—æ®µ

**å­¦ä¹ ç›®æ ‡**ï¼šå­¦ä¼šæ·»åŠ å­—å…¸ã€åˆ—è¡¨ç­‰å¤æ‚ç±»å‹çš„å­—æ®µ

#### å¤æ‚å­—æ®µç¤ºä¾‹

```python
from typing import Dict, Any

class AdvancedCustomState(TypedDict):
    # åŸºç¡€å­—æ®µ
    question: str
    answer: Optional[str]
    
    # ç®€å•å­—æ®µ
    user_id: str
    language: str
    
    # ğŸ¯ å¤æ‚å­—æ®µ
    user_preferences: Dict[str, Any]    # ç”¨æˆ·åå¥½ï¼ˆå­—å…¸ï¼‰
    session_metadata: Dict[str, Any]    # ä¼šè¯å…ƒæ•°æ®
    statistics: Dict[str, int]          # ç»Ÿè®¡ä¿¡æ¯
    processing_log: List[str]           # å¤„ç†æ—¥å¿—ï¼ˆåˆ—è¡¨ï¼‰
```

#### ä½¿ç”¨å¤æ‚å­—æ®µ

```python
# åˆ›å»ºçŠ¶æ€
state = AdvancedCustomState(
    question="å¦‚ä½•å­¦ä¹  Pythonï¼Ÿ",
    answer=None,
    user_id="user-67890",
    language="zh-CN",
    
    # ğŸ¯ è®¾ç½®å¤æ‚å­—æ®µ
    user_preferences={
        "detail_level": "detailed",  # è¯¦ç»†ç¨‹åº¦
        "include_examples": True,    # æ˜¯å¦åŒ…å«ç¤ºä¾‹
        "max_length": 500           # æœ€å¤§é•¿åº¦
    },
    session_metadata={
        "device": "desktop",
        "browser": "Chrome"
    },
    statistics={
        "question_count": 0,
        "answer_count": 0
    },
    processing_log=[]  # ç©ºåˆ—è¡¨
)

# åœ¨èŠ‚ç‚¹ä¸­ä½¿ç”¨
def smart_node(state: AdvancedCustomState) -> AdvancedCustomState:
    # ğŸ” è¯»å–å¤æ‚å­—æ®µ
    detail_level = state['user_preferences']['detail_level']
    include_examples = state['user_preferences']['include_examples']
    
    # ğŸ¯ æ ¹æ®åå¥½ç”Ÿæˆç­”æ¡ˆ
    if detail_level == "brief":
        answer = "ç®€çŸ­ç­”æ¡ˆ..."
    else:
        answer = "è¯¦ç»†ç­”æ¡ˆ..."
        if include_examples:
            answer += "\nç¤ºä¾‹ï¼š..."
    
    state['answer'] = answer
    
    # ğŸ¯ æ›´æ–°ç»Ÿè®¡
    state['statistics']['answer_count'] += 1
    
    # ğŸ¯ æ·»åŠ æ—¥å¿—
    state['processing_log'].append("ç­”æ¡ˆå·²ç”Ÿæˆ")
    
    return state
```

---

### ç»ƒä¹  3ï¼šè§‚å¯Ÿ State å˜åŒ–

**å­¦ä¹ ç›®æ ‡**ï¼šè¿½è¸ª State åœ¨å¤šä¸ªèŠ‚ç‚¹é—´çš„å˜åŒ–è¿‡ç¨‹

#### æ·»åŠ æ—¥å¿—å­—æ®µ

```python
class ObservableState(TypedDict):
    question: str
    answer: Optional[str]
    
    # ğŸ¯ ç”¨äºè§‚å¯Ÿçš„å­—æ®µ
    processing_log: List[str]        # å¤„ç†æ—¥å¿—
    node_timings: Dict[str, float]   # èŠ‚ç‚¹æ‰§è¡Œæ—¶é—´
```

#### åœ¨èŠ‚ç‚¹ä¸­è®°å½•å˜åŒ–

```python
def retrieve_node(state: ObservableState) -> ObservableState:
    import time
    start_time = time.time()
    
    # ğŸ” è®°å½•å¼€å§‹
    state['processing_log'].append("[æ£€ç´¢èŠ‚ç‚¹] å¼€å§‹æ‰§è¡Œ")
    
    # æ‰§è¡Œæ£€ç´¢
    state['retrieved_docs'] = [...]
    
    # ğŸ” è®°å½•ç»“æœ
    state['processing_log'].append(
        f"[æ£€ç´¢èŠ‚ç‚¹] æ£€ç´¢åˆ° {len(state['retrieved_docs'])} ä¸ªæ–‡æ¡£"
    )
    
    # ğŸ” è®°å½•è€—æ—¶
    elapsed = time.time() - start_time
    state['node_timings']['retrieve'] = elapsed
    
    return state
```

#### æŸ¥çœ‹å®Œæ•´æ—¥å¿—

```python
# æ‰§è¡Œå¤šä¸ªèŠ‚ç‚¹
state = retrieve_node(state)
state = generate_node(state)
state = postprocess_node(state)

# ğŸ” æ‰“å°å®Œæ•´æ—¥å¿—
for i, log in enumerate(state['processing_log'], 1):
    print(f"{i}. {log}")

# è¾“å‡ºï¼š
# 1. [æ£€ç´¢èŠ‚ç‚¹] å¼€å§‹æ‰§è¡Œ
# 2. [æ£€ç´¢èŠ‚ç‚¹] æ£€ç´¢åˆ° 2 ä¸ªæ–‡æ¡£
# 3. [æ£€ç´¢èŠ‚ç‚¹] æ‰§è¡Œè€—æ—¶: 0.002s
# 4. [ç”ŸæˆèŠ‚ç‚¹] å¼€å§‹æ‰§è¡Œ
# 5. [ç”ŸæˆèŠ‚ç‚¹] ç­”æ¡ˆç”Ÿæˆå®Œæˆ
# ...
```

---

## ğŸ¯ ç»ƒä¹  4ï¼šä½ çš„ä»»åŠ¡

### ä»»åŠ¡è¯´æ˜

åœ¨ `examples/practice_custom_state.py` çš„ç»ƒä¹  4 ä¸­ï¼Œæ·»åŠ ä»¥ä¸‹å­—æ®µå¹¶å®ç°ä½¿ç”¨å®ƒä»¬çš„èŠ‚ç‚¹ï¼š

```python
class YourCustomState(TypedDict):
    question: str
    answer: Optional[str]
    
    # ========== ä½ çš„ä»»åŠ¡ ==========
    temperature: float          # LLM æ¸©åº¦å‚æ•° (0.0 - 1.0)
    max_tokens: int             # æœ€å¤§ç”Ÿæˆé•¿åº¦
    knowledge_base: str         # ä½¿ç”¨çš„çŸ¥è¯†åº“åç§°
    debug_mode: bool            # æ˜¯å¦å¯ç”¨è°ƒè¯•æ¨¡å¼
    # ==============================
```

### å®ç°æ­¥éª¤

#### æ­¥éª¤ 1ï¼šå®šä¹‰å­—æ®µ

æ‰“å¼€ `examples/practice_custom_state.py`ï¼Œæ‰¾åˆ° `practice_4_your_turn()` å‡½æ•°ï¼š

```python
class YourCustomState(TypedDict):
    question: str
    answer: Optional[str]
    
    # æ·»åŠ ä½ çš„å­—æ®µ
    temperature: float
    max_tokens: int
    knowledge_base: str
    debug_mode: bool
```

#### æ­¥éª¤ 2ï¼šåˆ›å»ºå®ä¾‹

```python
state = YourCustomState(
    question="å¦‚ä½•å­¦ä¹  RAGï¼Ÿ",
    answer=None,
    temperature=0.7,           # ğŸ¯ æ¸©åº¦å‚æ•°
    max_tokens=500,            # ğŸ¯ æœ€å¤§é•¿åº¦
    knowledge_base="tech_kb",  # ğŸ¯ çŸ¥è¯†åº“
    debug_mode=True            # ğŸ¯ è°ƒè¯•æ¨¡å¼
)
```

#### æ­¥éª¤ 3ï¼šç¼–å†™èŠ‚ç‚¹

```python
def your_custom_node(state: YourCustomState) -> YourCustomState:
    """ä½ çš„è‡ªå®šä¹‰èŠ‚ç‚¹"""
    
    # è¯»å–å­—æ®µ
    kb = state['knowledge_base']
    temp = state['temperature']
    max_tokens = state['max_tokens']
    debug = state['debug_mode']
    
    if debug:
        print(f"[è°ƒè¯•] ä½¿ç”¨çŸ¥è¯†åº“: {kb}")
        print(f"[è°ƒè¯•] æ¸©åº¦å‚æ•°: {temp}")
        print(f"[è°ƒè¯•] æœ€å¤§é•¿åº¦: {max_tokens}")
    
    # æ ¹æ®å‚æ•°ç”Ÿæˆç­”æ¡ˆ
    state['answer'] = f"åŸºäº {kb} çŸ¥è¯†åº“ç”Ÿæˆçš„ç­”æ¡ˆ..."
    
    return state
```

#### æ­¥éª¤ 4ï¼šè¿è¡Œå¹¶è§‚å¯Ÿ

```bash
python examples/practice_custom_state.py
```

---

## ğŸ’¡ å¸¸è§é—®é¢˜

### Q1: ä¸ºä»€ä¹ˆè¦æ·»åŠ è‡ªå®šä¹‰å­—æ®µï¼Ÿ

**A**: æ ¹æ®å®é™…éœ€æ±‚æ‰©å±• State åŠŸèƒ½

**ç¤ºä¾‹åœºæ™¯**ï¼š
- `user_id` - è®°å½•æ˜¯å“ªä¸ªç”¨æˆ·çš„è¯·æ±‚
- `language` - æ”¯æŒå¤šè¯­è¨€
- `temperature` - æ§åˆ¶ LLM ç”Ÿæˆçš„éšæœºæ€§
- `processing_log` - è°ƒè¯•å’Œç›‘æ§
- `statistics` - æ€§èƒ½åˆ†æ

### Q2: å¯ä»¥æ·»åŠ ä»»æ„ç±»å‹çš„å­—æ®µå—ï¼Ÿ

**A**: ç†è®ºä¸Šå¯ä»¥ï¼Œä½†å»ºè®®ï¼š

âœ… **æ¨èçš„ç±»å‹**ï¼š
- åŸºæœ¬ç±»å‹ï¼š`str`, `int`, `float`, `bool`
- åˆ—è¡¨ï¼š`List[str]`, `List[Document]`
- å­—å…¸ï¼š`Dict[str, Any]`
- LangChain ç±»å‹ï¼š`Document`, `BaseMessage`

âš ï¸ **é¿å…çš„ç±»å‹**ï¼š
- å¤§æ–‡ä»¶å†…å®¹ï¼ˆåº”å­˜å‚¨è·¯å¾„ï¼‰
- æ¨¡å‹å®ä¾‹ï¼ˆåº”åœ¨èŠ‚ç‚¹ä¸­åˆ›å»ºï¼‰
- ä¸å¯åºåˆ—åŒ–çš„å¯¹è±¡

### Q3: å­—æ®µå‘½åæœ‰ä»€ä¹ˆè§„èŒƒå—ï¼Ÿ

**A**: éµå¾ª Python å‘½åè§„èŒƒ

âœ… **å¥½çš„å‘½å**ï¼š
```python
user_id: str                  # æ¸…æ™°ã€å…·ä½“
max_tokens: int               # æè¿°æ€§å¼º
is_debug_mode: bool           # å¸ƒå°”å€¼ç”¨ is/has å¼€å¤´
processing_log: List[str]     # å¤æ•°è¡¨ç¤ºåˆ—è¡¨
```

âŒ **ä¸å¥½çš„å‘½å**ï¼š
```python
uid: str                      # å¤ªç®€çŸ­
data: Any                     # å¤ªæ¨¡ç³Š
temp: float                   # ä¸æ¸…æ¥šæ˜¯ä»€ä¹ˆ
flag: bool                    # ä»€ä¹ˆæ ‡å¿—ï¼Ÿ
```

### Q4: å¦‚ä½•åœ¨ç°æœ‰é¡¹ç›®ä¸­æ·»åŠ å­—æ®µï¼Ÿ

**A**: éµå¾ªå‘åå…¼å®¹åŸåˆ™

```python
# åŸå§‹ State
class AgentState(TypedDict):
    question: str
    answer: Optional[str]

# æ·»åŠ æ–°å­—æ®µï¼ˆä½¿ç”¨ Optionalï¼‰
class AgentState(TypedDict):
    question: str
    answer: Optional[str]
    
    # æ–°å­—æ®µéƒ½è®¾ä¸º Optionalï¼Œä¿è¯å…¼å®¹æ€§
    user_id: Optional[str]
    language: Optional[str]
```

---

## ğŸ“ å­¦ä¹ æ£€æŸ¥æ¸…å•

å®Œæˆç»ƒä¹ åï¼Œä½ åº”è¯¥èƒ½å¤Ÿï¼š

- [ ] ç†è§£ TypedDict çš„ä½œç”¨
- [ ] å®šä¹‰åŒ…å«è‡ªå®šä¹‰å­—æ®µçš„ State
- [ ] åœ¨èŠ‚ç‚¹ä¸­è¯»å–å’Œä¿®æ”¹è‡ªå®šä¹‰å­—æ®µ
- [ ] ä½¿ç”¨å¤æ‚ç±»å‹çš„å­—æ®µï¼ˆå­—å…¸ã€åˆ—è¡¨ï¼‰
- [ ] æ·»åŠ æ—¥å¿—å­—æ®µè¿½è¸ª State å˜åŒ–
- [ ] æ ¹æ®è‡ªå®šä¹‰å­—æ®µå®ç°ä¸åŒçš„é€»è¾‘
- [ ] è®¾è®¡é€‚åˆè‡ªå·±é¡¹ç›®çš„ State ç»“æ„

---

## ğŸš€ ä¸‹ä¸€æ­¥

### ç»§ç»­å­¦ä¹ 

1. **å®Œæˆç»ƒä¹  4** - å®ç°ä½ è‡ªå·±çš„å­—æ®µ
2. **ä¿®æ”¹æµ‹è¯•æ–‡ä»¶** - åœ¨ `test_agent_state.py` ä¸­æ·»åŠ å­—æ®µ
3. **è®¾è®¡å®é™… State** - æ€è€ƒä½ çš„é¡¹ç›®éœ€è¦å“ªäº›å­—æ®µ

### è¿›é˜¶ä¸»é¢˜

1. **èŠ‚ç‚¹å®ç°** - `src/agent/nodes.py`
2. **å›¾æ„å»º** - `src/agent/graph.py`
3. **å®æˆ˜é¡¹ç›®** - æ„å»ºå®Œæ•´çš„ RAG Agent

---

## ğŸ“– å‚è€ƒèµ„æ–™

- `examples/practice_custom_state.py` - ç»ƒä¹ æ–‡ä»¶
- `examples/test_agent_state.py` - å®Œæ•´æµ‹è¯•
- `docs/é˜¶æ®µä¸‰_Stateå®ç°æŒ‡å¼•.md` - è¯¦ç»†æŒ‡å¼•
- `src/agent/state.py` - æºä»£ç 

---

**ç¥ä½ å­¦ä¹ æ„‰å¿«ï¼åŠ¨æ‰‹å®è·µæ˜¯æœ€å¥½çš„å­¦ä¹ æ–¹å¼ï¼** ğŸ’ªâœ¨
