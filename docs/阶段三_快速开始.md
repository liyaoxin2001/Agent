# é˜¶æ®µä¸‰ï¼šLangGraph Agent - å¿«é€Ÿå¼€å§‹

## ğŸ‰ æ¬¢è¿è¿›å…¥é˜¶æ®µä¸‰ï¼

ä½ å·²ç»æˆåŠŸå®Œæˆäº†é˜¶æ®µä¸€å’Œé˜¶æ®µäºŒï¼Œç°åœ¨å‡†å¤‡å­¦ä¹  LangGraph Agent - è¿™æ˜¯ AI Agent å¼€å‘çš„æ ¸å¿ƒæŠ€æœ¯ï¼

---

## ğŸ“‹ æœ¬é˜¶æ®µç›®æ ‡

å­¦ä¹ ä½¿ç”¨ LangGraph æ„å»ºæ™ºèƒ½ Agentï¼Œå®ç°ï¼š
- âœ… çŠ¶æ€ç®¡ç†ï¼ˆAgentStateï¼‰
- âœ… èŠ‚ç‚¹å®šä¹‰ï¼ˆNodesï¼‰
- âœ… å›¾æ„å»ºï¼ˆGraphï¼‰
- âœ… æ¡ä»¶åˆ†æ”¯ï¼ˆConditional Edgesï¼‰
- âœ… å¤šæ­¥éª¤æ¨ç†

---

## ğŸ“ å·²å®Œæˆçš„æ–‡ä»¶

### 1. `src/agent/state.py` âœ…

**å†…å®¹**ï¼šå®šä¹‰äº†ä¸‰ä¸ªç‰ˆæœ¬çš„ AgentState

| ç‰ˆæœ¬ | ç±»å | é€‚ç”¨åœºæ™¯ |
|------|------|----------|
| åŸºç¡€ç‰ˆ | `AgentStateBasic` | ç®€å• RAG æµç¨‹ï¼Œé€‚åˆå­¦ä¹  |
| å¯¹è¯ç‰ˆ | `AgentStateConversational` | å¤šè½®å¯¹è¯ï¼ŒæŸ¥è¯¢æ”¹å†™ |
| å®Œæ•´ç‰ˆ | `AgentState` | ç”Ÿäº§ç¯å¢ƒï¼ŒåŒ…å«æ‰€æœ‰åŠŸèƒ½ |

**è¾…åŠ©å‡½æ•°**ï¼š
- `create_initial_state()` - åˆ›å»ºå®Œæ•´ç‰ˆæœ¬çŠ¶æ€
- `create_basic_state()` - åˆ›å»ºåŸºç¡€ç‰ˆæœ¬çŠ¶æ€
- `create_conversational_state()` - åˆ›å»ºå¯¹è¯ç‰ˆæœ¬çŠ¶æ€

### 2. `examples/test_agent_state.py` âœ…

**å†…å®¹**ï¼š5ä¸ªæµ‹è¯•ç”¨ä¾‹ï¼Œæ¼”ç¤ºæ‰€æœ‰ State ç‰ˆæœ¬çš„ä½¿ç”¨

| æµ‹è¯• | åŠŸèƒ½ |
|------|------|
| æµ‹è¯•1 | åŸºç¡€ç‰ˆæœ¬ State çš„ä½¿ç”¨ |
| æµ‹è¯•2 | å¯¹è¯ç‰ˆæœ¬ State çš„ä½¿ç”¨ï¼ˆå«ä»£è¯æ¶ˆè§£ï¼‰ |
| æµ‹è¯•3 | å®Œæ•´ç‰ˆæœ¬ State çš„ä½¿ç”¨ï¼ˆç”Ÿäº§çº§ï¼‰ |
| æµ‹è¯•4 | é”™è¯¯å¤„ç† |
| æµ‹è¯•5 | æ­¥éª¤é™åˆ¶ï¼ˆé˜²æ­¢æ— é™å¾ªç¯ï¼‰ |

### 3. `docs/é˜¶æ®µä¸‰_Stateå®ç°æŒ‡å¼•.md` âœ…

**å†…å®¹**ï¼š30,000+ å­—è¯¦ç»†æŒ‡å¼•
- State æ¦‚å¿µè¯¦è§£
- å­—æ®µè®¾è®¡åŸåˆ™
- ä¸‰ä¸ªç‰ˆæœ¬çš„å®Œæ•´è¯´æ˜
- ä½¿ç”¨ç¤ºä¾‹å’Œæœ€ä½³å®è·µ
- å¸¸è§é—®é¢˜è§£ç­”

---

## ğŸš€ å¦‚ä½•å¼€å§‹æµ‹è¯•

### æ–¹æ³•1ï¼šä½¿ç”¨å‘½ä»¤è¡Œï¼ˆæ¨èï¼‰

```bash
# 1. æ¿€æ´»condaç¯å¢ƒ
conda activate pytorch2.6.0

# 2. è¿›å…¥é¡¹ç›®ç›®å½•
cd E:\PythonProject\HuahuaChat

# 3. è¿è¡Œæµ‹è¯•
python examples/test_agent_state.py
```

### æ–¹æ³•2ï¼šä½¿ç”¨ IDE

1. åœ¨ VS Code / Cursor ä¸­æ‰“å¼€ `examples/test_agent_state.py`
2. ç¡®ä¿é€‰æ‹©äº†æ­£ç¡®çš„ Python è§£é‡Šå™¨ï¼ˆpytorch2.6.0ï¼‰
3. ç‚¹å‡»è¿è¡ŒæŒ‰é’®

### é¢„æœŸè¾“å‡º

```
============================================================
ğŸš€ Agent State æµ‹è¯•å’Œå­¦ä¹ ç¤ºä¾‹
============================================================

è¿™ä¸ªæµ‹è¯•å°†æ¼”ç¤º AgentState çš„ä¸‰ä¸ªç‰ˆæœ¬åŠå…¶ä½¿ç”¨åœºæ™¯ã€‚

============================================================
æµ‹è¯• 1: åŸºç¡€ç‰ˆæœ¬ AgentState
============================================================

ğŸ“ æ­¥éª¤ 1: åˆ›å»ºåˆå§‹çŠ¶æ€
âœ… çŠ¶æ€åˆ›å»ºæˆåŠŸ:
   - question: Python æ˜¯ä»€ä¹ˆï¼Ÿ
   - retrieved_docs: None
   - answer: None

ğŸ“ æ­¥éª¤ 2: æ¨¡æ‹Ÿæ£€ç´¢èŠ‚ç‚¹æ›´æ–°
âœ… æ£€ç´¢å®Œæˆ:
   - æ£€ç´¢åˆ° 2 ä¸ªæ–‡æ¡£
   - æ–‡æ¡£ 1: Python æ˜¯ä¸€ç§é«˜çº§ç¼–ç¨‹è¯­è¨€ï¼Œä»¥å…¶ç®€æ´æ˜“è¯»çš„è¯­æ³•è€Œé—»åã€‚
   - æ–‡æ¡£ 2: Python å¹¿æ³›åº”ç”¨äº Web å¼€å‘ã€æ•°æ®ç§‘å­¦ã€äººå·¥æ™ºèƒ½ç­‰é¢†åŸŸã€‚

ğŸ“ æ­¥éª¤ 3: æ¨¡æ‹Ÿç”ŸæˆèŠ‚ç‚¹æ›´æ–°
âœ… ç”Ÿæˆå®Œæˆ:
   - ç­”æ¡ˆ: Python æ˜¯ä¸€ç§é«˜çº§ç¼–ç¨‹è¯­è¨€ï¼Œä»¥å…¶ç®€æ´æ˜“è¯»çš„è¯­æ³•è€Œé—»åï¼Œå¹¿æ³›åº”ç”¨äºå¤šä¸ªé¢†åŸŸã€‚

âœ… åŸºç¡€ç‰ˆæœ¬æµ‹è¯•é€šè¿‡ï¼

... (æ›´å¤šæµ‹è¯•è¾“å‡º)

============================================================
âœ… æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼
============================================================

ğŸ“š ä¸‹ä¸€æ­¥å­¦ä¹ :
   1. é˜…è¯» docs/é˜¶æ®µä¸‰_Stateå®ç°æŒ‡å¼•.md
   2. å­¦ä¹ èŠ‚ç‚¹å®ç°: src/agent/nodes.py
   3. å­¦ä¹ å›¾æ„å»º: src/agent/graph.py
```

---

## ğŸ“š å­¦ä¹ è·¯å¾„

### ç¬¬1æ­¥ï¼šç†è§£ State æ¦‚å¿µï¼ˆä»Šå¤©ï¼‰

**é˜…è¯»**ï¼š
- âœ… `docs/é˜¶æ®µä¸‰_Stateå®ç°æŒ‡å¼•.md`ï¼ˆåˆšåˆšå®Œæˆï¼‰

**å®è·µ**ï¼š
- âœ… è¿è¡Œ `python examples/test_agent_state.py`
- âœ… ä¿®æ”¹æµ‹è¯•ä»£ç ï¼Œå°è¯•æ·»åŠ è‡ªå®šä¹‰å­—æ®µ
- âœ… ç†è§£ä¸‰ä¸ªç‰ˆæœ¬çš„åŒºåˆ«å’Œä½¿ç”¨åœºæ™¯

**æ€è€ƒ**ï¼š
- State ä¸ºä»€ä¹ˆéœ€è¦ TypedDictï¼Ÿ
- å“ªäº›å­—æ®µæ˜¯å¿…å¡«çš„ï¼Œå“ªäº›æ˜¯å¯é€‰çš„ï¼Ÿ
- å¦‚ä½•åœ¨èŠ‚ç‚¹é—´ä¼ é€’æ•°æ®ï¼Ÿ

### ç¬¬2æ­¥ï¼šå®ç°èŠ‚ç‚¹ï¼ˆæ˜å¤©ï¼‰

**å°†è¦å­¦ä¹ **ï¼š
- `src/agent/nodes.py`
- å¦‚ä½•ç¼–å†™ retrieve_nodeï¼ˆæ£€ç´¢èŠ‚ç‚¹ï¼‰
- å¦‚ä½•ç¼–å†™ generate_nodeï¼ˆç”ŸæˆèŠ‚ç‚¹ï¼‰
- å¦‚ä½•ç¼–å†™ decide_nodeï¼ˆå†³ç­–èŠ‚ç‚¹ï¼‰

**å…³é”®æ¦‚å¿µ**ï¼š
- èŠ‚ç‚¹æ˜¯å¤„ç† State çš„å‡½æ•°
- èŠ‚ç‚¹å¯ä»¥è¯»å–å’Œä¿®æ”¹ State
- èŠ‚ç‚¹å¯ä»¥è¿”å›å®Œæ•´ State æˆ–éƒ¨åˆ†æ›´æ–°

### ç¬¬3æ­¥ï¼šæ„å»ºå›¾ï¼ˆåå¤©ï¼‰

**å°†è¦å­¦ä¹ **ï¼š
- `src/agent/graph.py`
- å¦‚ä½•ä½¿ç”¨ StateGraph åˆ›å»º Agent
- å¦‚ä½•è¿æ¥èŠ‚ç‚¹
- å¦‚ä½•å®ç°æ¡ä»¶åˆ†æ”¯

**å…³é”®æ¦‚å¿µ**ï¼š
- Graph å®šä¹‰äº†èŠ‚ç‚¹çš„æ‰§è¡Œé¡ºåº
- Conditional Edges å®ç°åŠ¨æ€å†³ç­–
- START å’Œ END æ˜¯ç‰¹æ®ŠèŠ‚ç‚¹

### ç¬¬4æ­¥ï¼šå®Œæ•´æµ‹è¯•ï¼ˆç¬¬4å¤©ï¼‰

**å°†è¦å®ç°**ï¼š
- å®Œæ•´çš„ RAG Agent
- å¤šæ­¥éª¤æ¨ç†æµç¨‹
- é”™è¯¯å¤„ç†å’Œé‡è¯•é€»è¾‘

---

## ğŸ¯ ä»Šå¤©çš„ä»»åŠ¡æ¸…å•

- [x] é˜…è¯» `docs/é˜¶æ®µä¸‰_Stateå®ç°æŒ‡å¼•.md`
- [x] è¿è¡Œ `python examples/test_agent_state.py`
- [ ] ç†è§£ä¸‰ä¸ªç‰ˆæœ¬ State çš„åŒºåˆ«
- [ ] å°è¯•ä¿®æ”¹æµ‹è¯•ä»£ç ï¼Œæ·»åŠ è‡ªå®šä¹‰å­—æ®µ
- [ ] ç”»å‡º State åœ¨èŠ‚ç‚¹é—´ä¼ é€’çš„æµç¨‹å›¾

---

## ğŸ’¡ å¿«é€Ÿå‚è€ƒ

### State ç‰ˆæœ¬é€‰æ‹©æŒ‡å—

```python
# åœºæ™¯1: å­¦ä¹  LangGraphï¼Œç®€å•çš„ RAG
from src.agent.state import create_basic_state
state = create_basic_state("Pythonæ˜¯ä»€ä¹ˆï¼Ÿ")

# åœºæ™¯2: éœ€è¦å¤šè½®å¯¹è¯
from src.agent.state import create_conversational_state
state = create_conversational_state(
    question="å®ƒçš„åº”ç”¨é¢†åŸŸæœ‰å“ªäº›ï¼Ÿ",
    messages=[...],  # å†å²æ¶ˆæ¯
    max_steps=5
)

# åœºæ™¯3: ç”Ÿäº§ç¯å¢ƒï¼Œå®Œæ•´åŠŸèƒ½
from src.agent.state import create_initial_state
state = create_initial_state(
    question="RAG ç³»ç»Ÿçš„åŸç†æ˜¯ä»€ä¹ˆï¼Ÿ",
    max_steps=10,
    conversation_id="conv-123",
    metadata={"user_id": "user-456"}
)
```

### State å­—æ®µé€ŸæŸ¥è¡¨

| å­—æ®µ | ç±»å‹ | ç”¨é€” | ä½•æ—¶å¡«å…… |
|------|------|------|----------|
| `question` | str | ç”¨æˆ·é—®é¢˜ | åˆå§‹åŒ– |
| `retrieved_docs` | List[Document] | æ£€ç´¢ç»“æœ | retrieve èŠ‚ç‚¹ |
| `answer` | str | æœ€ç»ˆç­”æ¡ˆ | generate èŠ‚ç‚¹ |
| `messages` | List[BaseMessage] | å¯¹è¯å†å² | æ¯è½®å¯¹è¯å |
| `step_count` | int | æ­¥éª¤è®¡æ•° | æ¯ä¸ªèŠ‚ç‚¹ +1 |
| `next_action` | str | ä¸‹ä¸€æ­¥åŠ¨ä½œ | decide èŠ‚ç‚¹ |

---

## ğŸ” è°ƒè¯•æŠ€å·§

### 1. æ‰“å° State å†…å®¹

```python
def retrieve_node(state: AgentState) -> AgentState:
    print(f"ğŸ” å½“å‰ State:")
    print(f"   - question: {state['question']}")
    print(f"   - step_count: {state['step_count']}")
    
    # ... èŠ‚ç‚¹é€»è¾‘
    
    return state
```

### 2. ä½¿ç”¨ JSON æ ¼å¼åŒ–è¾“å‡º

```python
import json

def debug_state(state: AgentState):
    # æ³¨æ„ï¼šéœ€è¦è¿‡æ»¤æ‰ä¸èƒ½åºåˆ—åŒ–çš„å¯¹è±¡ï¼ˆå¦‚ Documentï¼‰
    debug_info = {
        "question": state["question"],
        "answer": state["answer"],
        "step_count": state["step_count"],
        "error": state["error"]
    }
    print(json.dumps(debug_info, indent=2, ensure_ascii=False))
```

### 3. è¿½è¸ªèŠ‚ç‚¹æ‰§è¡Œ

```python
def track_execution(state: AgentState, node_name: str):
    state["current_node"] = node_name
    print(f"â†’ è¿›å…¥èŠ‚ç‚¹: {node_name} (æ­¥éª¤ {state['step_count']})")
```

---

## â“ å¸¸è§é—®é¢˜

### Q1: State ä¼šä¸ä¼šè¶Šæ¥è¶Šå¤§ï¼Ÿ

**A**: ä¸ä¼šã€‚æ¯æ¬¡å¯¹è¯éƒ½æ˜¯æ–°çš„ Stateï¼Œæ‰§è¡Œå®Œæ¯•åä¼šé‡Šæ”¾å†…å­˜ã€‚

```python
# æ¯æ¬¡å¯¹è¯ç‹¬ç«‹
state1 = create_initial_state("é—®é¢˜1")
result1 = graph.invoke(state1)  # æ‰§è¡Œå®Œæ¯•ï¼Œstate1 é‡Šæ”¾

state2 = create_initial_state("é—®é¢˜2")
result2 = graph.invoke(state2)  # æ–°çš„ state2
```

### Q2: å¯ä»¥åœ¨ State ä¸­å­˜å‚¨ä»€ä¹ˆï¼Ÿ

**A**: ä»»ä½• Python å¯¹è±¡ï¼Œä½†å»ºè®®ï¼š
- âœ… åŸºæœ¬ç±»å‹ï¼ˆstr, int, float, boolï¼‰
- âœ… LangChain å¯¹è±¡ï¼ˆDocument, BaseMessageï¼‰
- âœ… åˆ—è¡¨å’Œå­—å…¸
- âš ï¸ é¿å…å­˜å‚¨å¤§å¯¹è±¡ï¼ˆå¦‚å¤§æ–‡ä»¶ã€å¤§æ¨¡å‹ï¼‰

### Q3: èŠ‚ç‚¹å¿…é¡»è¿”å›å®Œæ•´ State å—ï¼Ÿ

**A**: ä¸éœ€è¦ã€‚å¯ä»¥åªè¿”å›æ›´æ–°çš„å­—æ®µï¼š

```python
# æ–¹å¼1: è¿”å›å®Œæ•´ State
def node1(state):
    state["answer"] = "..."
    return state  # è¿”å›æ•´ä¸ª state

# æ–¹å¼2: åªè¿”å›æ›´æ–°éƒ¨åˆ†
def node2(state):
    return {"answer": "..."}  # LangGraph ä¼šè‡ªåŠ¨åˆå¹¶
```

### Q4: å¦‚ä½•æ·»åŠ è‡ªå®šä¹‰å­—æ®µï¼Ÿ

**A**: ç›´æ¥åœ¨ `AgentState` ä¸­å®šä¹‰ï¼š

```python
class AgentState(TypedDict):
    # æ ‡å‡†å­—æ®µ
    question: str
    answer: Optional[str]
    
    # è‡ªå®šä¹‰å­—æ®µ
    user_id: str
    language: str
    custom_data: Dict[str, Any]
```

---

## ğŸ“– æ¨èé˜…è¯»

1. **LangGraph å®˜æ–¹æ–‡æ¡£**
   - [State æ¦‚å¿µ](https://langchain-ai.github.io/langgraph/concepts/low_level/#state)
   - [å…¥é—¨æ•™ç¨‹](https://langchain-ai.github.io/langgraph/tutorials/introduction/)

2. **é¡¹ç›®æ–‡æ¡£**
   - `docs/é˜¶æ®µä¸‰_Stateå®ç°æŒ‡å¼•.md` - è¯¦ç»†æŒ‡å¼•
   - `src/agent/state.py` - æºä»£ç å’Œæ³¨é‡Š

3. **Python TypedDict**
   - [å®˜æ–¹æ–‡æ¡£](https://docs.python.org/3/library/typing.html#typing.TypedDict)

---

## ğŸŠ æ€»ç»“

**ä½ å·²ç»å®Œæˆ**ï¼š
- âœ… AgentState å®šä¹‰ï¼ˆ3ä¸ªç‰ˆæœ¬ï¼‰
- âœ… è¾…åŠ©å‡½æ•°å®ç°
- âœ… å®Œæ•´æµ‹è¯•ç”¨ä¾‹
- âœ… è¯¦ç»†æ–‡æ¡£

**ä¸‹ä¸€æ­¥**ï¼š
- ğŸ“˜ é˜…è¯» State å®ç°æŒ‡å¼•
- ğŸ§ª è¿è¡Œå¹¶ä¿®æ”¹æµ‹è¯•ä»£ç 
- ğŸ¨ ç”»å‡º State æµè½¬å›¾
- ğŸš€ å‡†å¤‡å­¦ä¹ èŠ‚ç‚¹å®ç°

---

**åŠ æ²¹ï¼Agent å¼€å‘çš„å¤§é—¨å·²ç»æ‰“å¼€ï¼** ğŸš€
