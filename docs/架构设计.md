# 项目架构设计

## 一、整体架构

```
┌─────────────┐
│  Web UI     │  (Streamlit/Gradio)
└──────┬──────┘
       │ HTTP
┌──────▼──────┐
│  FastAPI    │  (REST API)
└──────┬──────┘
       │
┌──────▼──────────────────────────┐
│      Core Layer                 │
│  ┌──────────┐  ┌─────────────┐ │
│  │   LLM    │  │  Embedding  │ │
│  └──────────┘  └─────────────┘ │
│  ┌──────────┐  ┌─────────────┐ │
│  │ VectorDB │  │   Chain     │ │
│  └──────────┘  └─────────────┘ │
└──────┬──────────────────────────┘
       │
┌──────▼──────────────────────────┐
│  Knowledge Base & Agent Layer   │
│  ┌──────────────┐  ┌─────────┐ │
│  │ Knowledge    │  │ Agent   │ │
│  │ Base Manager │  │ (Graph) │ │
│  └──────────────┘  └─────────┘ │
└─────────────────────────────────┘
```

## 二、核心模块设计

### 2.1 LLM 模块 (`src/core/llm/`)

**职责**：封装不同的 LLM 调用

**接口设计**：
```python
class BaseLLM:
    def generate(self, prompt: str) -> str:
        """生成回答"""
        pass
    
    def stream_generate(self, prompt: str):
        """流式生成"""
        pass
```

**实现类**：
- `OpenAILLM` - OpenAI API
- `OllamaLLM` - 本地 Ollama
- `XinferenceLLM` - Xinference

### 2.2 Embedding 模块 (`src/core/embedding/`)

**职责**：文本向量化

**接口设计**：
```python
class BaseEmbedding:
    def embed_query(self, text: str) -> List[float]:
        """对查询文本向量化"""
        pass
    
    def embed_documents(self, texts: List[str]) -> List[List[float]]:
        """对文档列表向量化"""
        pass
```

### 2.3 向量存储模块 (`src/core/vectorstore/`)

**职责**：向量存储和检索

**接口设计**：
```python
class BaseVectorStore:
    def add_documents(self, documents: List[Document], embeddings: List[List[float]]):
        """添加文档到向量库"""
        pass
    
    def similarity_search(self, query: str, k: int = 4) -> List[Document]:
        """相似度检索"""
        pass
```

### 2.4 Chain 模块 (`src/core/chain/`)

**职责**：实现 RAG 链

**核心类**：
- `RAGChain` - 基础 RAG 链
- `ConversationalRAGChain` - 带记忆的 RAG 链

### 2.5 知识库管理 (`src/knowledge_base/`)

**职责**：管理多个知识库

**核心类**：
- `KnowledgeBase` - 单个知识库
- `KnowledgeBaseManager` - 知识库管理器

**数据结构**：
```python
{
    "kb_name": "my_kb",
    "vectorstore": VectorStore,
    "documents": List[Document],
    "metadata": {...}
}
```

### 2.6 Agent 模块 (`src/agent/`)

**职责**：使用 LangGraph 实现 Agent

**核心文件**：
- `graph.py` - 定义图结构
- `nodes.py` - 定义各个节点
- `state.py` - 定义状态结构
- `tools.py` - 定义工具

**Agent 流程示例**：
```
开始 → 理解问题 → 检索知识库 → 是否需要工具？ 
  ↓                                    ↓
  └────────── 生成回答 ←──────────────┘
```

## 三、数据流

### 3.1 文档入库流程

```
上传文档 
  → 文档解析 (Document Loader)
  → 文本切分 (Text Splitter)
  → 向量化 (Embedding)
  → 存储到向量库 (VectorStore)
  → 保存元数据
```

### 3.2 问答流程

```
用户问题
  → 问题向量化
  → 向量检索 (相似度搜索)
  → 组装 Prompt (问题 + 检索到的上下文)
  → LLM 生成
  → 返回答案
```

### 3.3 Agent 流程

```
用户问题
  → Agent 节点1: 理解问题类型
  → Agent 节点2: 根据类型选择路径
    ├─ 路径A: 检索知识库 → 生成回答
    ├─ 路径B: 调用工具 → 处理结果 → 生成回答
    └─ 路径C: 多步骤推理 → 生成回答
  → 返回最终答案
```

## 四、配置文件设计

### 4.1 模型配置 (`config/model_config.yaml`)

```yaml
llm:
  provider: "openai"  # or "ollama", "xinference"
  model_name: "gpt-3.5-turbo"
  api_key: "${OPENAI_API_KEY}"
  temperature: 0.7

embedding:
  provider: "openai"
  model_name: "text-embedding-ada-002"
  api_key: "${OPENAI_API_KEY}"

vectorstore:
  type: "faiss"  # or "chroma", "milvus"
  persist_directory: "./data/vectorstores"
```

### 4.2 知识库配置 (`config/kb_config.yaml`)

```yaml
default_kb: "default"
knowledge_bases:
  - name: "default"
    path: "./data/knowledge_base/default"
    chunk_size: 500
    chunk_overlap: 50
```

## 五、API 设计

### 5.1 REST API 端点

```
POST   /api/v1/chat          # 发送消息
POST   /api/v1/kb/create     # 创建知识库
POST   /api/v1/kb/upload     # 上传文档
GET    /api/v1/kb/list       # 列出知识库
DELETE /api/v1/kb/{kb_name}  # 删除知识库
```

### 5.2 WebSocket (可选)

```
/ws/chat  # 流式对话
```

## 六、扩展点

### 6.1 可扩展的组件

1. **向量数据库**：FAISS → Chroma → Milvus
2. **LLM 提供商**：OpenAI → Ollama → 本地模型
3. **文档类型**：PDF → Word → Markdown → 网页
4. **Agent 工具**：搜索 → 计算器 → 代码执行

### 6.2 优化方向

1. **检索优化**：
   - 重排序 (Reranker)
   - 混合检索 (关键词 + 向量)
   - 多路检索

2. **生成优化**：
   - Prompt 工程
   - Few-shot 示例
   - 链式思考

3. **Agent 优化**：
   - 更复杂的决策逻辑
   - 工具链调用
   - 自我反思机制

